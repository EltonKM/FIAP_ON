SELECT
   A.TP_LOCALIZACAO
  ,A.TP_DEPENDENCIA
  ,A.NO_REGIAO
  ,A.NO_UF
  ,ROUND(SUM(B.NU_PARTICIPANTES),0) AS NU_PARTICIPANTES_ENEM
  ,ROUND(AVG(B.NU_MEDIA_CN),0) AS MEDIA_CIENCIAS_NATUREZA
  ,ROUND(AVG(B.NU_MEDIA_CH),0) AS MEDIA_CIENCIAS_HUMANAS
  ,ROUND(AVG(B.NU_MEDIA_LP),0) AS MEDIA_LINGUA_PORTUGUESA
  ,ROUND(AVG(B.NU_MEDIA_MT),0) AS MEDIA_MATEMATICA
  ,ROUND(AVG(B.NU_MEDIA_RED),0) AS MEDIA_REDACAO
  ,C.IN_AGUA_INEXISTENTE
  ,C.IN_ENERGIA_INEXISTENTE
  ,C.IN_ESGOTO_INEXISTENTE
  ,C.IN_BANHEIRO
  ,C.IN_BIBLIOTECA
  ,C.IN_COZINHA
  ,C.IN_LABORATORIO_CIENCIAS
  ,C.IN_LABORATORIO_INFORMATICA
  ,C.IN_QUADRA_ESPORTES
  ,C.IN_ACESSIBILIDADE_CORRIMAO
  ,C.IN_ACESSIBILIDADE_RAMPAS
  ,C.IN_ACESSIBILIDADE_INEXISTENTE
  ,C.IN_DESKTOP_ALUNO
  ,C.IN_TABLET_ALUNO
  ,C.IN_INTERNET
  ,C.IN_INTERNET_ALUNOS
  ,ROUND((SUM(B.NU_MEDIA_CN + B.NU_MEDIA_CH + B.NU_MEDIA_LP + B.NU_MEDIA_MT + B.NU_MEDIA_RED)/5),0) AS MEDIA_ENEM
  ,IF(IN_AGUA_INEXISTENTE = 2, 1, 0)
  +IF(IN_ENERGIA_INEXISTENTE = 2, 1, 0)
  +IF(IN_ESGOTO_INEXISTENTE = 2, 1, 0)
  +IF(IN_BANHEIRO = 1, 1, 0)
  +IF(IN_BIBLIOTECA = 1, 1, 0)
  +IF(IN_COZINHA = 1, 1, 0)
  +IF(IN_LABORATORIO_CIENCIAS = 1, 1, 0)
  +IF(IN_LABORATORIO_INFORMATICA = 1, 1, 0)
  +IF(IN_QUADRA_ESPORTES = 1, 1, 0)
  +IF(IN_ACESSIBILIDADE_CORRIMAO = 1, 1, 0)  
  +IF(IN_ACESSIBILIDADE_RAMPAS = 1, 1, 0)
  +IF(IN_ACESSIBILIDADE_INEXISTENTE = 2, 1, 0)
  +IF(IN_DESKTOP_ALUNO = 1, 1, 0)
  +IF(IN_TABLET_ALUNO = 1, 1, 0)
  +IF(IN_INTERNET = 1, 1, 0)
  +IF(IN_INTERNET_ALUNOS = 1, 1, 0) AS PONTUACAO_INFRA
  ,COUNT(1) AS CONTAGEM
FROM
TB_ESCOLAS A
LEFT JOIN TB_ESCOLAS_ENEM B
  ON A.CO_ENTIDADE = B.CO_ESCOLA_EDUCACENSO
LEFT JOIN TB_ESCOLAS_INFRA C
  ON A.CO_ENTIDADE = C.CO_ENTIDADE
GROUP BY
   A.TP_LOCALIZACAO
  ,A.TP_DEPENDENCIA
  ,A.NO_REGIAO
  ,A.NO_UF
  ,C.IN_AGUA_INEXISTENTE
  ,C.IN_ENERGIA_INEXISTENTE
  ,C.IN_ESGOTO_INEXISTENTE
  ,C.IN_BANHEIRO
  ,C.IN_BIBLIOTECA
  ,C.IN_COZINHA
  ,C.IN_LABORATORIO_CIENCIAS
  ,C.IN_LABORATORIO_INFORMATICA
  ,C.IN_QUADRA_ESPORTES
  ,C.IN_ACESSIBILIDADE_CORRIMAO
  ,C.IN_ACESSIBILIDADE_RAMPAS
  ,C.IN_ACESSIBILIDADE_INEXISTENTE
  ,C.IN_DESKTOP_ALUNO
  ,C.IN_TABLET_ALUNO
  ,C.IN_INTERNET
  ,C.IN_INTERNET_ALUNOS
--HAVING AVG(NU_MEDIA_CN) > 600
;
